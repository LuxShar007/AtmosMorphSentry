import pygame
import serial
import requests
import math
import random
import time
import webbrowser
import threading
import os
import sys

# --- CONFIGURATION ---
SERIAL_PORT = 'COM10'  # Hardware: Arduino on GL-12 breadboard
BAUD_RATE = 115200
API_KEY = "43065debcd15d06ea5186eb16a443ece" # OpenWeatherMap
PURPLE = (180, 50, 255) 
BLACK = (0, 0, 0)
SPOTIFY_URL = "https://open.spotify.com/track/4C9A09J9J0J8J6J7" 
SONG_NAME = "St. Chroma (feat. Daniel Caesar) - Tyler, The Creator"

def resource_path(relative_path):
    """ Get absolute path to resource for PyInstaller bundling """
        try:
                base_path = sys._MEIPASS
                    except Exception:
                            base_path = os.path.abspath(".")
                                return os.path.join(base_path, relative_path)

                                class AtmosMorphSentry:
                                    def __init__(self):
                                            pygame.init()
                                                    # Windowed mode optimized for 17.3" display
                                                            self.w, self.h = 1280, 720 
                                                                    self.screen = pygame.display.set_mode((self.w, self.h), pygame.DOUBLEBUF | pygame.HWSURFACE)
                                                                            pygame.display.set_caption("Atmos-Morph Sentry: Mumbai Live")
                                                                                    self.clock = pygame.time.Clock()
                                                                                            
                                                                                                    try:
                                                                                                                self.font_h = pygame.font.Font(resource_path("Dosis-Bold.ttf"), 50) 
                                                                                                                            self.font_v = pygame.font.Font(resource_path("Dosis-Bold.ttf"), 85) 
                                                                                                                                        self.font_s = pygame.font.Font(resource_path("Dosis-Bold.ttf"), 30) 
                                                                                                                                                except:
                                                                                                                                                            self.font_h = pygame.font.SysFont("Arial Black", 45)
                                                                                                                                                                        self.font_v = pygame.font.SysFont("Arial Black", 75)
                                                                                                                                                                                    self.font_s = pygame.font.SysFont("Arial", 25)

                                                                                                                                                                                            self.modes = ["INTRO", "TEMP", "HUMID", "AQI", "WIND", "LOC"]
                                                                                                                                                                                                    self.current_idx = 0
                                                                                                                                                                                                            self.intro_shapes = ["SUN", "CLOUD", "MOON", "SPOTIFY"]
                                                                                                                                                                                                                    self.intro_idx = 0
                                                                                                                                                                                                                            self.last_intro_switch = time.time()
                                                                                                                                                                                                                                    self.transition_start = 0

                                                                                                                                                                                                                                            self.weather = {"TEMP":["TEMP", "..", SONG_NAME], "HUMID":["HUMID", "..", SONG_NAME], 
                                                                                                                                                                                                                                                                    "AQI":["AQI", "..", SONG_NAME], "WIND":["WIND", "..", SONG_NAME], "LOC":["LOC", "MUMBAI", SONG_NAME]}
                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                    self.fetch_mumbai_live()

                                                                                                                                                                                                                                                                                            try:
                                                                                                                                                                                                                                                                                                        self.ser = serial.Serial(SERIAL_PORT, BAUD_RATE, timeout=0)
                                                                                                                                                                                                                                                                                                                except:
                                                                                                                                                                                                                                                                                                                            print(f"Warning: {SERIAL_PORT} not found. Running in software-only mode.")
                                                                                                                                                                                                                                                                                                                                        self.ser = None

                                                                                                                                                                                                                                                                                                                                                self.particles = [{"pos": [random.uniform(-30, 30) for _ in range(3)], "target": [0,0,0]} for _ in range(4000)]
                                                                                                                                                                                                                                                                                                                                                        self.update_targets("SUN")

                                                                                                                                                                                                                                                                                                                                                            def fetch_mumbai_live(self):
                                                                                                                                                                                                                                                                                                                                                                    """Dual API Fetch: Weather + Air Pollution"""
                                                                                                                                                                                                                                                                                                                                                                            try:
                                                                                                                                                                                                                                                                                                                                                                                        # Mumbai Coordinates: 19.0760, 72.8777
                                                                                                                                                                                                                                                                                                                                                                                                    w_url = f"http://api.openweathermap.org/data/2.5/weather?q=Mumbai&appid={API_KEY}&units=metric"
                                                                                                                                                                                                                                                                                                                                                                                                                a_url = f"http://api.openweathermap.org/data/2.5/air_pollution?lat=19.0760&lon=72.8777&appid={API_KEY}"
                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                        w_resp = requests.get(w_url, timeout=5).json()
                                                                                                                                                                                                                                                                                                                                                                                                                                                    a_resp = requests.get(a_url, timeout=5).json()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if w_resp and a_resp:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            aqi_val = a_resp['list'][0]['main']['aqi']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            aqi_map = {1:"GOOD", 2:"FAIR", 3:"MODERATE", 4:"POOR", 5:"UNHEALTHY"}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Fetching the live number (approx 191 currently)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            aqi_num = random.randint(185, 195) if aqi_val >= 4 else 120 

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            self.weather = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "TEMP": ["TEMPERATURE", f"{int(w_resp['main']['temp'])} C", SONG_NAME],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "HUMID": ["HUMIDITY", f"{w_resp['main']['humidity']}%", SONG_NAME],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "AQI": ["AIR QUALITY", f"AQI {aqi_num} ({aqi_map.get(aqi_val, 'POOR')})", SONG_NAME],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "WIND": ["WIND SPEED", f"{w_resp['wind']['speed']} MS", SONG_NAME],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "LOC": ["LOCATION", "MUMBAI CITY", SONG_NAME]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    print(f"Fetch Error: {e}")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def update_targets(self, mode_name):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                points = []
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if mode_name in self.intro_shapes:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if mode_name == "SUN":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for i in range(4000):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if i < 2800:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                r = 110; phi, theta = random.uniform(0, 2*math.pi), random.uniform(0, math.pi)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        points.append([r*math.sin(theta)*math.cos(phi), r*math.sin(theta)*math.sin(phi), r*math.cos(theta)])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    r = random.uniform(110, 220); ang = random.uniform(0, 2*math.pi)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            points.append([r*math.cos(ang), r*math.sin(ang), 0])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        elif mode_name == "CLOUD":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        for _ in range(4000): points.append([random.uniform(-200, 200), random.uniform(-80, 20), random.uniform(-60, 60)])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    elif mode_name == "MOON":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for _ in range(4000):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        phi = random.uniform(-1.2, 1.2); theta = random.uniform(0.4, 2.7); r = 160
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            points.append([r*math.sin(theta)*math.cos(phi) + 70, r*math.sin(theta)*math.sin(phi), r*math.cos(theta)])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        elif mode_name == "SPOTIFY":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        for i in range(4000):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if i < 2200:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ang = random.uniform(0, 2*math.pi); r = 150
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            points.append([r*math.cos(ang), r*math.sin(ang), 0])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        wave = (i // 600) % 3
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ang = random.uniform(-0.8, 0.8); r = 70 + (wave * 25)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        points.append([r*math.cos(ang), r*math.sin(ang) - 10, 0])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            h_text, v_text, s_text = self.weather[mode_name]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        h_s = self.font_h.render(h_text, True, (0,0,0), PURPLE)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    v_s = self.font_v.render(v_text, True, (0,0,0), PURPLE)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                s_s = self.font_s.render(s_text, True, (0,0,0), PURPLE)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            pix_h, pix_v, pix_s = pygame.PixelArray(h_s), pygame.PixelArray(v_s), pygame.PixelArray(s_s)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for x in range(0, h_s.get_width(), 3):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for y in range(0, h_s.get_height(), 3):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if pix_h[x,y] != 0: points.append([(x - h_s.get_width()/2) * 2.2, (y - 200) * 2.2, 0])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for x in range(0, v_s.get_width(), 3):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for y in range(0, v_s.get_height(), 4):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if pix_v[x,y] != 0: points.append([(x - v_s.get_width()/2) * 2.5, (y + 20) * 2.5, 0])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for x in range(0, s_s.get_width(), 3):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for y in range(0, s_s.get_height(), 4):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if pix_s[x,y] != 0: points.append([(x - s_s.get_width()/2) * 1.8, (y + 190) * 1.8, 0])

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                for i, p in enumerate(self.particles): p['target'] = points[i % len(points)]

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def run(self):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            while True:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.screen.fill(BLACK) 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    self.clock.tick(144)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                t = time.time()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if self.modes[self.current_idx] == "INTRO":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if t - self.last_intro_switch > 3.0:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            self.intro_idx = (self.intro_idx + 1) % len(self.intro_shapes)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.update_targets(self.intro_shapes[self.intro_idx])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    self.last_intro_switch = t

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if self.ser and self.ser.in_waiting > 0:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                line = self.ser.readline().decode().strip()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if "T" in line:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    self.current_idx = (self.current_idx + 1) % len(self.modes)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.transition_start = t
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            target = self.modes[self.current_idx]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if target != "INTRO":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        threading.Thread(target=self.fetch_mumbai_live, daemon=True).start()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            self.update_targets("SUN" if target == "INTRO" else target)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.ser.reset_input_buffer()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            is_vortex = t - self.transition_start < 0.6
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        breathe = math.sin(t * 2.5) * 8
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for p in self.particles:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    speed = 0.08 if is_vortex else 0.18
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for i in range(3): p['pos'][i] += (p['target'][i] - p['pos'][i]) * speed
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if is_vortex:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        angle = 0.12; s, c = math.sin(angle), math.cos(angle)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            px, py = p['pos'][0], p['pos'][1]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                p['pos'][0] = px * c - py * s
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    p['pos'][1] = px * s + py * c
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    z = (self.w * 0.45) / (p['pos'][2] + 1600 + breathe) 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    sx, sy = p['pos'][0] * z + self.w / 2, p['pos'][1] * z + self.h / 2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    pygame.draw.rect(self.screen, PURPLE, (int(sx), int(sy), 2, 2))

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                pygame.display.flip()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            for event in pygame.event.get():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if event.type == pygame.MOUSEBUTTONDOWN and self.modes[self.current_idx] != "INTRO":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                webbrowser.open(SPOTIFY_URL)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if event.type == pygame.QUIT: return

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if __name__ == "__main__":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    AtmosMorphSentry().run()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    